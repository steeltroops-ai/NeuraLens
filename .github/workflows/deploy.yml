name: Deploy NeuraLens to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Deploy target (all, frontend, backend)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - frontend
          - backend

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Frontend Deployment to Netlify
  # ============================================
  deploy-frontend:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_target != 'backend' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        working-directory: ./frontend
        run: bun install --frozen-lockfile

      - name: Build Next.js app
        working-directory: ./frontend
        run: bun run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}
          NEXT_PUBLIC_ENVIRONMENT: production

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2.1
        with:
          publish-dir: './frontend/.next'
          production-deploy: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.sha }}"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5

  # ============================================
  # Backend Deployment to HuggingFace Spaces
  # ============================================
  deploy-backend:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_target != 'frontend' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Prepare HuggingFace Space
        run: |
          cd backend
          
          # Create Dockerfile for HuggingFace Space
          cat > Dockerfile << 'EOF'
          FROM python:3.11-slim
          
          WORKDIR /app
          
          # Install system dependencies
          RUN apt-get update && apt-get install -y \
              libsndfile1 \
              libgl1-mesa-glx \
              libglib2.0-0 \
              && rm -rf /var/lib/apt/lists/*
          
          # Copy requirements first for caching
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          
          # Copy application code
          COPY app/ ./app/
          
          # Expose port
          EXPOSE 7860
          
          # Health check
          HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
              CMD curl -f http://localhost:7860/api/v1/health || exit 1
          
          # Run the application
          CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "7860"]
          EOF
          
          # Create README for HuggingFace
          cat > README.md << 'EOF'
          ---
          title: NeuraLens Backend API
          emoji: ðŸ§ 
          colorFrom: blue
          colorTo: purple
          sdk: docker
          sdk_version: "1.0"
          app_port: 7860
          pinned: false
          license: mit
          ---
          
          # NeuraLens Backend API
          
          AI-powered neurological assessment platform backend.
          
          ## Endpoints
          
          - `GET /api/v1/health` - Health check
          - `POST /api/v1/speech/analyze` - Speech analysis
          - `POST /api/v1/retinal/analyze` - Retinal imaging
          - `POST /api/v1/cognitive/analyze` - Cognitive testing
          - `POST /api/v1/nri/calculate` - NRI fusion
          EOF

      - name: Push to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USERNAME: ${{ secrets.HF_USERNAME }}
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          cd backend
          
          # Configure git for HuggingFace
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          
          # Initialize a new git repo for HuggingFace
          rm -rf .git
          git init
          
          # Add HuggingFace remote
          git remote add hf https://${HF_USERNAME}:${HF_TOKEN}@huggingface.co/spaces/${HF_USERNAME}/${HF_SPACE_NAME}
          
          # Add all files
          git add .
          git commit -m "Deploy from GitHub Actions - $(date +%Y%m%d-%H%M%S)"
          
          # Push to HuggingFace (force push to overwrite)
          git push hf main --force

  # ============================================
  # Keep HuggingFace Space Alive (Cron Job)
  # ============================================
  keep-alive:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
      - name: Ping HuggingFace Space
        run: |
          curl -s --max-time 30 ${{ secrets.API_URL }}/api/v1/health || true
          echo "Pinged HuggingFace Space to prevent sleeping"

  # ============================================
  # Notify on Completion
  # ============================================
  notify:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: always()
    
    steps:
      - name: Check deployment status
        run: |
          if [ "${{ needs.deploy-frontend.result }}" == "success" ] && [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "All deployments successful!"
            echo "Frontend: https://neuralens.netlify.app"
            echo "Backend: https://your-username-neuralens.hf.space"
          else
            echo "Some deployments failed. Check logs above."
            exit 1
          fi
